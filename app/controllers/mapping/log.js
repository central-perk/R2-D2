// Generated by CoffeeScript 1.7.1
var LOGFILE_STATUS, config, fCheckLogSize, fCreateLogFile, fWriteFile, fWriteableLog, fs, logFileDao, logsPath, path, utils;

path = require('path');

fs = require('fs-extra');

utils = process.g.utils;

config = process.g.config;

LOGFILE_STATUS = config.STATUS.LOGFILE;

logsPath = process.g.logsPath;

logFileDao = require(process.g.daoPath).logFile;

fWriteableLog = function(sLogModelName, callback) {
  var appID, sLogType;
  appID = sLogModelName.split('.')[0];
  sLogType = sLogModelName.split('.')[1];
  return logFileDao.getOne({
    appID: appID,
    type: sLogType,
    status: LOGFILE_STATUS.writeable
  }, function(err, oWriteableLog) {
    var bLogSizeOK, sWriteableLog, sWriteableLogPath;
    if (!err) {
      if (oWriteableLog) {
        sWriteableLog = oWriteableLog.name;
        sWriteableLogPath = path.join(logsPath, sWriteableLog);
        bLogSizeOK = fCheckLogSize(sWriteableLogPath);
        if (bLogSizeOK) {
          return callback(null, sWriteableLogPath);
        } else {
          logFileDao.update({
            name: sWriteableLog
          }, {
            status: LOGFILE_STATUS.unstorage
          }, function(err, doc) {
            var kue;
            if (config.STORAGE.delay) {
              kue = utils.getCtrl('kue');
              return setTimeout(function() {
                return kue.enqueueStorage({
                  name: sWriteableLog,
                  status: LOGFILE_STATUS.unstorage
                });
              }, config.STORAGE.delay);
            }
          });
          return fCreateLogFile(sLogModelName, callback);
        }
      } else {
        return fCreateLogFile(sLogModelName, callback);
      }
    } else {
      return callback('日志文件查询失败');
    }
  });
};

fCheckLogSize = function(sWriteableLogPath) {
  var e, nSize;
  try {
    nSize = fs.readFileSync(sWriteableLogPath, 'utf8').length;
    return config.LOG_MAX_SIZE > nSize;
  } catch (_error) {
    e = _error;
    return false;
  }
};

fCreateLogFile = function(sLogModelName, callback) {
  var appID, sLogType, sWriteableLog, sWriteableLogPath;
  appID = sLogModelName.split('.')[0];
  sLogType = sLogModelName.split('.')[1];
  sWriteableLog = "" + sLogModelName + "." + (utils.getTime()) + ".log";
  sWriteableLogPath = path.join(logsPath, sWriteableLog);
  fs.createFileSync(sWriteableLogPath);
  return logFileDao.create({
    appID: appID,
    type: sLogType,
    name: sWriteableLog
  }, function(err, raw) {
    return callback(err, sWriteableLogPath);
  });
};

fWriteFile = function(sWriteableLogPath) {
  return function(message, cb) {
    var sLogFileName;
    sLogFileName = path.basename(sWriteableLogPath);
    message.fileName = sLogFileName;
    message = JSON.stringify(message, null, 0) + '\n';
    if (!fs.existsSync(sWriteableLogPath)) {
      createFileSync(sWriteableLogPath);
    }
    return fs.writeFile(sWriteableLogPath, message, {
      encoding: 'utf8',
      flag: 'a'
    }, cb);
  };
};

module.exports = function(sLogModelName, callback) {
  return fWriteableLog(sLogModelName, function(err, sWriteableLogPath) {
    return callback(err, fWriteFile(sWriteableLogPath));
  });
};
