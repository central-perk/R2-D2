// Generated by CoffeeScript 1.7.1
var aAuth, auth, ctrl, path;

path = require('path');

ctrl = require(path.join(process.g.controllersPath, 'mapping', 'index'));

auth = require(path.join(process.g.controllersPath, 'mapping', 'auth'));

aAuth = {};

module.exports = {
  distribute: function(req, res, next) {
    var appID, token, ts, type;
    console.log(aAuth);
    type = req.query._type;
    appID = Number(req.query.appID);
    token = req.query.token;
    ts = req.query.ts;
    if (!type) {
      return res.requestError('缺少type');
    } else if (!ts) {
      return res.requestError('缺少ts');
    } else if (!appID) {
      return res.requestError('缺少appID');
    } else if (!token) {
      return res.requestError('缺少token');
    } else {
      if (aAuth.appID && aAuth.appID.token === token) {
        delete req.query._type;
        req.type = type;
        return ctrl.fWriteLog(req, res);
      } else {
        return auth.get({
          appID: appID
        }, function(err, oAuth) {
          if (oAuth && oAuth.token === token) {
            aAuth.appID = {
              token: token
            };
            delete req.query._type;
            req.type = type;
            return ctrl.fWriteLog(req, res);
          }
        });
      }
    }
  }
};
