// Generated by CoffeeScript 1.7.1
var aAuth, async, auth, basicAuth, ctrl, fEnqueue, i, kue, logModel, path, utils;

path = require('path');

async = require('async');

basicAuth = require('connect-basic-auth');

utils = process.g.utils;

ctrl = utils.getCtrl('index');

auth = utils.getCtrl('auth');

kue = utils.getCtrl('kue');

logModel = utils.getCtrl('logModel');

aAuth = {};

fEnqueue = function(req, res) {
  var oLogTemp, sAppID, sLogName;
  sAppID = req.params.appID;
  sLogName = req.params.name;
  oLogTemp = {
    appID: sAppID,
    name: sLogName,
    log: req.body
  };
  kue.enqueueLog(oLogTemp);
  return res.success('数据提交成功');
};

i = 1;

module.exports = {
  distribute: function(req, res, next) {
    var nLevel, nTs, oBody, sAppID, sFullLogName, sLogName, sToken;
    oBody = req.body;
    sAppID = req.params.appID;
    sLogName = req.params.name;
    sToken = req.params.token;
    nTs = oBody.ts;
    nLevel = oBody.level;
    sFullLogName = "" + sAppID + "." + sLogName;
    if (!sAppID) {
      return res.error('缺少appID');
    } else if (!sLogName) {
      return res.error('缺少日志名');
    } else if (!sToken) {
      return res.error('缺少秘钥');
    } else if (!nTs) {
      return res.error('缺少时间戳');
    } else if (!nLevel) {
      return res.error('缺少日志等级');
    } else {
      if (aAuth[sFullLogName]) {
        if (aAuth[sFullLogName] === sToken) {
          return fEnqueue(req, res);
        } else {
          return res.error('授权信息错误');
        }
      } else {
        return async.waterfall([
          function(cb) {
            return auth._checkAuth({
              appID: sAppID,
              token: sToken
            }, function(err, bAuthorized) {
              if (!err) {
                if (bAuthorized) {
                  return cb(null, null);
                } else {
                  return cb('应用未授权');
                }
              } else {
                return cb('授权信息检验失败');
              }
            });
          }, function(result, cb) {
            return logModel.checkLogModel({
              appID: sAppID,
              name: sLogName
            }, function(err, bLogModel) {
              if (!err) {
                if (bLogModel) {
                  return cb(null, null);
                } else {
                  return cb('日志模型不存在');
                }
              } else {
                return cb('日志模型检验失败');
              }
            });
          }
        ], function(err, result) {
          if (!err) {
            aAuth[sFullLogName] = sToken;
            return fEnqueue(req, res);
          } else {
            return res.error(err);
          }
        });
      }
    }
  },
  basicAuth: function() {
    return basicAuth(function(credentials, req, res, next) {
      if (credentials && credentials.username === "cer" && credentials.password === "site") {
        return next();
      } else {
        if (!credentials) {
          console.log("credentials not provided");
        }
        if (credentials && credentials.username) {
          console.log("credentials-username:" + credentials.username);
        }
        if (credentials && credentials.password) {
          console.log("credentials-password:" + credentials.username);
        }
        return next("Unautherized!");
      }
    });
  }
};
