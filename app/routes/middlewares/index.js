// Generated by CoffeeScript 1.7.1
var aAuth, auth, ctrl, fEnqueue, kue, path, utils;

path = require('path');

utils = process.g.utils;

ctrl = utils.getCtrl('index');

auth = utils.getCtrl('auth');

kue = utils.getCtrl('kue');

aAuth = {};

fEnqueue = function(req, res) {
  req.type = req.query.type;
  delete req.query.type;
  delete req.query.appID;
  delete req.query.token;
  kue(req);
  return res.requestSucceed('数据提交成功');
};

module.exports = {
  distribute: function(req, res, next) {
    var appID, token, ts, type;
    type = req.query.type;
    appID = Number(req.query.appID);
    token = req.query.token;
    ts = req.query.ts;
    if (!type) {
      return res.requestError('缺少type');
    } else if (!ts) {
      return res.requestError('缺少ts');
    } else if (!appID) {
      return res.requestError('缺少appID');
    } else if (!token) {
      return res.requestError('缺少token');
    } else {
      if (!require('mongoose').models[type]) {
        return res.requestError('日志类型不存在，请先创建');
      } else {
        if (aAuth[appID]) {
          if (aAuth[appID]['token'] === token) {
            return fEnqueue(req, res);
          } else {
            return res.requestError('未被授权');
          }
        } else {
          return auth.get({
            appID: appID
          }, function(err, oAuth) {
            if (oAuth && oAuth.token === token) {
              aAuth[appID] = {
                token: token
              };
              return fEnqueue(req, res);
            } else {
              return res.requestError('未被授权');
            }
          });
        }
      }
    }
  }
};
